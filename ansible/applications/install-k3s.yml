# install-k3s.yml
# Installs K3s cluster with single server and multiple agents
# Disables built-in Traefik and ServiceLB for custom installation

# === PLAY 1: Install K3s server ===
- name: Install K3s server
  hosts: k3s_servers
  become: true
  tasks:
    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Download K3s installer
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /usr/local/bin/k3s-install.sh
        mode: '0755'
      when: not k3s_binary.stat.exists

    - name: Install K3s server
      ansible.builtin.shell: /usr/local/bin/k3s-install.sh
      args:
        executable: /bin/bash
      environment:
        K3S_KUBECONFIG_MODE: "644"
        INSTALL_K3S_EXEC: >-
          server
          --snapshotter=native
          --disable=traefik
          --disable=servicelb
          --write-kubeconfig-mode=644
          --tls-san={{ ansible_host }}
          --node-external-ip={{ ansible_host }}
      when: not k3s_binary.stat.exists

    - name: Wait for K3s API to be ready
      ansible.builtin.command: kubectl get --raw=/readyz
      register: api_ready
      retries: 30
      delay: 5
      until: api_ready.rc == 0
      changed_when: false

    - name: Verify K3s service is running
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: yes

    - name: Read node token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_raw

    - name: Save server facts
      ansible.builtin.set_fact:
        k3s_server_url: "https://{{ ansible_host }}:6443"
        k3s_cluster_token: "{{ k3s_token_raw.content | b64decode | trim }}"
        cacheable: yes

    - name: Display cluster info
      ansible.builtin.debug:
        msg: "K3s server installed at {{ k3s_server_url }}"

# === PLAY 2: Install K3s agents ===
- name: Install K3s agents
  hosts: k3s_agents
  become: true
  vars:
    primary_server: "{{ groups['k3s_servers'][0] }}"
  tasks:
    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Download K3s installer
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /usr/local/bin/k3s-install.sh
        mode: '0755'
      when: not k3s_binary.stat.exists

    - name: Wait for server API to be available
      ansible.builtin.wait_for:
        host: "{{ hostvars[primary_server].ansible_host }}"
        port: 6443
        timeout: 300

    - name: Install K3s agent
      ansible.builtin.shell: |
        K3S_URL="{{ hostvars[primary_server].k3s_server_url }}" \
        K3S_TOKEN="{{ hostvars[primary_server].k3s_cluster_token }}" \
        /usr/local/bin/k3s-install.sh
      args:
        executable: /bin/bash
      environment:
        INSTALL_K3S_EXEC: >-
          agent
          --snapshotter=native
          --node-external-ip={{ ansible_host }}
      when: not k3s_binary.stat.exists

    - name: Verify K3s agent service is running
      ansible.builtin.systemd:
        name: k3s-agent
        state: started
        enabled: yes

# === PLAY 3: Verify cluster ===
- name: Verify cluster installation
  hosts: k3s_servers[0]
  become: true
  tasks:
    - name: Wait for all nodes to be ready
      ansible.builtin.shell: kubectl get nodes --no-headers | grep -v Ready | wc -l
      register: unready_nodes
      retries: 30
      delay: 10
      until: unready_nodes.stdout | int == 0
      changed_when: false

    - name: Get cluster status
      ansible.builtin.command: kubectl get nodes
      register: cluster_status
      changed_when: false

    - name: Display cluster status
      ansible.builtin.debug:
        var: cluster_status.stdout_lines

    - name: Get system pods status
      ansible.builtin.command: kubectl get pods -n kube-system
      register: system_pods
      changed_when: false

    - name: Display system pods
      ansible.builtin.debug:
        var: system_pods.stdout_lines
