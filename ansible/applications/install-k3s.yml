# install-k3s.yml

# === PLAY 1: install and prepare k3s servers ===
- name: Install k3s servers
  hosts: k3s_servers
  become: true
  serial: 1
  tasks:
    - name: Download installer
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /usr/local/bin/k3s-install.sh
        mode: '0755'

    - name: Install k3s server
      ansible.builtin.shell: /usr/local/bin/k3s-install.sh
      args:
        executable: /bin/bash
      environment:
        K3S_KUBECONFIG_MODE: "644"
        INSTALL_K3S_EXEC: "server --snapshotter=native"   # ← safer for your LXCs

    - name: Wait for API
      ansible.builtin.command: kubectl get --raw=/readyz
      register: api_ready
      retries: 20
      delay: 3
      until: api_ready.rc == 0

    - name: Read token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_raw

    - name: Save server facts (use first server only)
      ansible.builtin.set_fact:
        k3s_server_url: "https://{{ ansible_host }}:6443"
        # slurp → b64decode → trim to kill the trailing newline
        k3s_cluster_token: "{{ k3s_token_raw.content | b64decode | trim }}"
      when: inventory_hostname == groups['k3s_servers'][0]

# === PLAY 2: install k3s agents, after servers are up ===
- name: Install k3s agents
  hosts: k3s_agents
  become: true
  vars:
    primary_server: "{{ groups['k3s_servers'][0] }}"
  tasks:
    - name: Download installer
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /usr/local/bin/k3s-install.sh
        mode: '0755'

    - name: Wait for server 6443 to listen
      ansible.builtin.wait_for:
        host: "{{ hostvars[primary_server].ansible_host }}"
        port: 6443
        timeout: 120

    - name: Install k3s agent (LXC-friendly)
      ansible.builtin.shell: |
        K3S_URL="{{ hostvars[primary_server].k3s_server_url }}" \
        K3S_TOKEN="{{ hostvars[primary_server].k3s_cluster_token }}" \
        /usr/local/bin/k3s-install.sh
      args:
        executable: /bin/bash
      environment:
        INSTALL_K3S_EXEC: "agent --snapshotter=native"   # ← key change
