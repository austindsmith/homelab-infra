# infra/ansible/k3s-apps.yml
- hosts: k3s_servers
  become: true
  vars:
    domain: theblacklodge.dev
  tasks:
    - name: ensure manifests dir exists
      file:
        path: /var/lib/rancher/k3s/server/manifests
        state: directory
        mode: 0755

    - name: cluster issuer for letsencrypt http
      copy:
        dest: /var/lib/rancher/k3s/server/manifests/cert-issuer.yaml
        mode: 0644
        content: |
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-http
          spec:
            acme:
              email: admin@{{ domain }}
              server: https://acme-v02.api.letsencrypt.org/directory
              privateKeySecretRef:
                name: letsencrypt-http
              solvers:
                - http01:
                    ingress:
                      class: traefik

    - name: demo app with ingress
      copy:
        dest: /var/lib/rancher/k3s/server/manifests/whoami.yaml
        mode: 0644
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: demo
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: whoami
            namespace: demo
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: whoami
            template:
              metadata:
                labels:
                  app: whoami
              spec:
                containers:
                  - name: whoami
                    image: traefik/whoami
                    ports:
                      - containerPort: 80
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: whoami
            namespace: demo
          spec:
            selector:
              app: whoami
            ports:
              - port: 80
                targetPort: 80
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: whoami
            namespace: demo
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-http
          spec:
            ingressClassName: traefik
            tls:
              - hosts: ["whoami.{{ domain }}"]
                secretName: whoami-tls
            rules:
              - host: whoami.{{ domain }}
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: whoami
                          port:
                            number: 80
