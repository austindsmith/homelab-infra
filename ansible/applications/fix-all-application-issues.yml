---
- name: Fix all application issues and ensure proper configuration
  hosts: k3s_servers[0]
  become: no
  tasks:
    - name: Fix Radarr service port to match container port
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: radarr
            namespace: apps
            labels:
              app: radarr
          spec:
            type: NodePort
            ports:
            - name: http
              port: 8989
              targetPort: 8989
              nodePort: 30597
            selector:
              app: radarr
        kubeconfig: ~/.kube/config

    - name: Create missing Radarr ingress
      k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: radarr
            namespace: apps
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web
          spec:
            rules:
            - host: radarr.theblacklodge.dev
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: radarr
                      port:
                        number: 8989
        kubeconfig: ~/.kube/config

    - name: Fix ArgoCD ingress hostname
      k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: argocd-ingress
            namespace: argocd
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web
          spec:
            rules:
            - host: argocd.theblacklodge.dev
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: argocd-server
                      port:
                        number: 80
        kubeconfig: ~/.kube/config

    - name: Fix Airbyte webapp configuration
      k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: airbyte-webapp
            namespace: datalake
            labels:
              app: airbyte-webapp
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: airbyte-webapp
            template:
              metadata:
                labels:
                  app: airbyte-webapp
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/port: "80"
              spec:
                containers:
                - name: airbyte-webapp
                  image: airbyte/webapp:0.50.33
                  ports:
                  - containerPort: 80
                  env:
                  - name: AIRBYTE_VERSION
                    value: "0.50.33"
                  - name: API_URL
                    value: "/api/v1/"
                  - name: INTERNAL_API_HOST
                    value: "airbyte-server:8001"
                  - name: CONNECTOR_BUILDER_API_HOST
                    value: "airbyte-server:8001"
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "250m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
        kubeconfig: ~/.kube/config

    - name: Fix Airbyte server database configuration
      k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: airbyte-server
            namespace: datalake
            labels:
              app: airbyte-server
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: airbyte-server
            template:
              metadata:
                labels:
                  app: airbyte-server
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/port: "8001"
              spec:
                containers:
                - name: airbyte-server
                  image: airbyte/server:0.50.33
                  ports:
                  - containerPort: 8001
                  env:
                  - name: AIRBYTE_VERSION
                    value: "0.50.33"
                  - name: DATABASE_URL
                    value: "jdbc:postgresql://postgresql.core.svc.cluster.local:5432/airbyte"
                  - name: DATABASE_USER
                    value: "airbyte"
                  - name: DATABASE_PASSWORD
                    value: "airbyte123"
                  - name: WORKSPACE_ROOT
                    value: "/tmp/workspace"
                  - name: WORKSPACE_DOCKER_MOUNT
                    value: "airbyte_workspace"
                  - name: LOCAL_ROOT
                    value: "/tmp/airbyte_local"
                  - name: LOCAL_DOCKER_MOUNT
                    value: "/tmp/airbyte_local"
                  - name: CONFIG_ROOT
                    value: "/data"
                  - name: TRACKING_STRATEGY
                    value: "logging"
                  - name: WEBAPP_URL
                    value: "http://airbyte-webapp"
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "250m"
                    limits:
                      memory: "1Gi"
                      cpu: "500m"
        kubeconfig: ~/.kube/config

    - name: Fix Dremio deployment with proper storage
      k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: dremio
            namespace: datalake
            labels:
              app: dremio
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: dremio
            template:
              metadata:
                labels:
                  app: dremio
              spec:
                containers:
                - name: dremio
                  image: dremio/dremio-oss:latest
                  ports:
                  - containerPort: 9047
                  - containerPort: 31010
                  env:
                  - name: DREMIO_JAVA_SERVER_EXTRA_OPTS
                    value: "-Dpaths.local=/opt/dremio/data/db -Xmx1g"
                  - name: DREMIO_MAX_HEAP_MEMORY_SIZE_MB
                    value: "1024"
                  volumeMounts:
                  - name: dremio-data
                    mountPath: /opt/dremio/data
                    subPath: dremio
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "250m"
                    limits:
                      memory: "1Gi"
                      cpu: "500m"
                volumes:
                - name: dremio-data
                  persistentVolumeClaim:
                    claimName: database-storage
        kubeconfig: ~/.kube/config

    - name: Fix Homepage to use proper subpath
      k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: homepage
            namespace: apps
          spec:
            template:
              spec:
                containers:
                - name: homepage
                  volumeMounts:
                  - mountPath: /app/config
                    name: homepage-config
                    subPath: homepage
        kubeconfig: ~/.kube/config

    - name: Display application fix summary
      debug:
        msg: |
          ðŸ”§ Application Fixes Applied:
          
          âœ… Fixed Issues:
          - Radarr service port: 7878 â†’ 8989 (matches container)
          - Radarr ingress: Created missing ingress resource
          - ArgoCD ingress: Fixed hostname argo â†’ argocd.theblacklodge.dev
          - Airbyte webapp: Added missing CONNECTOR_BUILDER_API_HOST
          - Airbyte server: Fixed DATABASE_URL format for PostgreSQL
          - Dremio: Configured proper storage with database-storage PVC
          - Homepage: Fixed to use proper subpath for config separation
          
          ðŸŽ¯ Expected Results:
          - All applications should now be accessible via their hostnames
          - PVC storage properly separated with subpaths
          - Centralized PostgreSQL working for all database apps
          - All ingress resources properly configured for Traefik
