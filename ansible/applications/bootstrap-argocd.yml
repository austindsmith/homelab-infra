# bootstrap-argocd.yml
# Bootstraps ArgoCD on the K3s cluster

- name: Bootstrap ArgoCD
  hosts: k3s_servers[0]
  become: true
  tasks:
    - name: Create ArgoCD namespace
      ansible.builtin.shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    - name: Install ArgoCD
      ansible.builtin.command: |
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      register: argocd_install
      changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

    - name: Wait for ArgoCD to be ready
      ansible.builtin.command: |
        kubectl wait --for=condition=available --timeout=600s deployment/argocd-server -n argocd
      register: argocd_ready
      retries: 10
      delay: 30
      until: argocd_ready.rc == 0
      changed_when: false

    - name: Get ArgoCD admin password
      ansible.builtin.shell: |
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false

    - name: Display ArgoCD access information
      ansible.builtin.debug:
        msg:
          - "ArgoCD has been installed successfully!"
          - "Access ArgoCD at: https://argo.theblacklodge.dev"
          - "Username: admin"
          - "Password: {{ argocd_password.stdout }}"
          - ""
          - "To access locally:"
          - "kubectl port-forward svc/argocd-server -n argocd 8080:443"
          - "Then visit: https://localhost:8080"

    - name: Create ArgoCD ingress
      ansible.builtin.copy:
        dest: /tmp/argocd-ingress.yaml
        content: |
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: argocd-server-ingress
            namespace: argocd
            annotations:
              kubernetes.io/ingress.class: traefik
              cert-manager.io/cluster-issuer: letsencrypt-dns
              traefik.ingress.kubernetes.io/router.tls: "true"
          spec:
            ingressClassName: traefik
            tls:
              - hosts:
                  - argo.theblacklodge.dev
                secretName: argocd-server-tls
            rules:
              - host: argo.theblacklodge.dev
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: argocd-server
                          port:
                            number: 443
        mode: '0644'

    - name: Apply ArgoCD ingress
      ansible.builtin.command: kubectl apply -f /tmp/argocd-ingress.yaml
      register: ingress_result
      changed_when: "'created' in ingress_result.stdout or 'configured' in ingress_result.stdout"

    - name: Clean up temporary file
      ansible.builtin.file:
        path: /tmp/argocd-ingress.yaml
        state: absent

    - name: Save ArgoCD password to file
      ansible.builtin.copy:
        content: "{{ argocd_password.stdout }}"
        dest: "{{ ansible_env.HOME }}/.argocd-password"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Final instructions
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "ArgoCD Bootstrap Complete!"
          - "========================================="
          - ""
          - "Next steps:"
          - "1. Wait for certificate to be issued (may take a few minutes)"
          - "2. Access ArgoCD at https://argo.theblacklodge.dev"
          - "3. Login with admin / {{ argocd_password.stdout }}"
          - "4. Deploy applications using ArgoCD Application manifests"
          - ""
          - "Password saved to: ~/.argocd-password"

