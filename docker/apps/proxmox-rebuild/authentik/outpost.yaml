version: "3.8"

networks:
  proxy:
    external: true   # must already exist and include your NPM container

services:
  authentik-proxy-outpost:
    image: ghcr.io/goauthentik/proxy:latest
    container_name: authentik-proxy-outpost
    restart: unless-stopped
    networks: [proxy]
    environment:
      # Your authentik base URL
      AUTHENTIK_HOST: "https://auth.theblacklodge.org"

      # Paste the Outpost token you copied from authentik’s Outpost wizard
      #AUTHENTIK_TOKEN: "<PASTE_OUTPOST_TOKEN>"

      # Outpost HTTP listener (internal only; NPM reaches it over the 'proxy' network)
      AUTHENTIK_LISTEN: "0.0.0.0:9000"

      # Optional: log level
      AUTHENTIK_LOG_LEVEL: "info"

      # If your auth.theblacklodge.org cert chain isn’t resolvable internally, set true while testing
      # AUTHENTIK_INSECURE: "true"
    # No host ports; NPM talks over the shared Docker network
    healthcheck:
      test: ["CMD", "sh", "-lc", "wget -qO- http://127.0.0.1:9000/outpost.go/health/ready || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s
