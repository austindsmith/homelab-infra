version: "3.8"

networks:
  proxy:
    external: true
    name: ${TRAEFIK_NETWORK}

services:
  hbbr:  # relay
    image: rustdesk/rustdesk-server:latest
    container_name: rustdesk-hbbr
    restart: unless-stopped
    command: hbbr
    environment:
      - TZ=${TZ}
    volumes:
      - ${RUSTDESK_DATA}:/data
    ports:
      - "${RELAY_PORT}:${RELAY_PORT}/tcp"        # 21117/tcp
    networks: [proxy]

  hbbs:  # rendezvous + web
    image: rustdesk/rustdesk-server:latest
    container_name: rustdesk-hbbs
    restart: unless-stopped
    # Point hbbs to the relay service
    command: hbbs -r rustdesk-hbbr:${RELAY_PORT}
    environment:
      - TZ=${TZ}
    depends_on:
      - hbbr
    volumes:
      - ${RUSTDESK_DATA}:/data
    # Non-HTTP ports must be exposed directly
    ports:
      - "${ID_PORT}:${ID_PORT}/tcp"              # 21115/tcp
      - "${RENDEZVOUS_PORT}:${RENDEZVOUS_PORT}/tcp"  # 21116/tcp
      - "${RENDEZVOUS_PORT}:${RENDEZVOUS_PORT}/udp"  # 21116/udp
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${TRAEFIK_ROUTER}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${TRAEFIK_ROUTER}.entrypoints=${TRAEFIK_ENTRYPOINT}"
      - "traefik.http.services.${TRAEFIK_ROUTER}.loadbalancer.server.port=${WEB_PORT}"
      # Optional: set a TLS certresolver if you have one defined in Traefik
      # - "traefik.http.routers.${TRAEFIK_ROUTER}.tls.certresolver=letsencrypt"
    networks: [proxy]
