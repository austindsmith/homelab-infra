version: "3.9"

networks:
  proxy:
    external: true
  ptero:
    driver: bridge

volumes:
  ptero_db:
  ptero_redis:
  panel_var:
  panel_nginx:
  panel_logs:

services:
  panel-db:
    image: mariadb:10.11
    container_name: ptero-panel-db
    restart: unless-stopped
    networks: [ptero]
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: panel
      MYSQL_USER: pterodactyl
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ptero_db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -u root -p$$MYSQL_ROOT_PASSWORD | grep 'mysqld is alive'"]
      interval: 20s
      timeout: 5s
      retries: 10

  panel-redis:
    image: redis:alpine
    container_name: ptero-panel-redis
    restart: unless-stopped
    networks: [ptero]
    command: ["--save","60","1","--loglevel","warning"]
    volumes:
      - ptero_redis:/data

  panel:
    image: ghcr.io/pterodactyl/panel:v1.11.11
    container_name: ptero-panel
    restart: unless-stopped
    depends_on:
      - panel-db
      - panel-redis
    networks: [ptero, proxy]
    environment:
      # core
      APP_URL: https://panel.${DOMAIN}
      APP_TIMEZONE: ${TZ}
      APP_ENV: production
      APP_ENVIRONMENT_ONLY: "false"
      APP_SERVICE_AUTHOR: ${PANEL_SERVICE_AUTHOR}
      TRUSTED_PROXIES: "*"

      # database & cache
      DB_HOST: panel-db
      DB_PORT: 3306
      DB_DATABASE: panel
      DB_USERNAME: pterodactyl
      DB_PASSWORD: ${MYSQL_PASSWORD}
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: panel-redis
      REDIS_PORT: 6379

      # mail (optional but recommended)
      MAIL_MAILER: ${MAIL_MAILER}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME}
    volumes:
      - panel_var:/app/var
      - panel_nginx:/etc/nginx/http.d
      - panel_logs:/app/storage/logs
    labels:
      - traefik.enable=true
      - traefik.http.routers.pteropanel.rule=Host(`panel.${DOMAIN}`)
      - traefik.http.routers.pteropanel.entrypoints=websecure
      - traefik.http.routers.pteropanel.tls.certresolver=letsencrypt
      - traefik.http.services.pteropanel.loadbalancer.server.port=80
